{% load static %}
<!DOCTYPE html>
<html>
    <head>
        <title>Result CSV Normalization</title>

        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primaryPurple: "#667AFF",
                            secondaryPurple: "#9E66FF",
                            black: "#333333",
                            gray: "#777777",
                            gray2: "#999999",
                            lightGray: "#D9D9D9",
                        },
                        fontFamily: {
                            montserrat: ["Montserrat", "sans-serif"],
                        },
                    },
                },
            };
        </script>
        <style>
            .pill-button {
                display: inline-flex;
                align-items: center;
                position: relative;
                padding: 5px;
                text-transform: uppercase;
                font-size: 20px;
                font-weight: 700;
                background: #fff;
                border-radius: 10px;
                color: #999;
                z-index: 0;
            }
            .pill-button-highlight {
                transition: all 0.2s;
                position: absolute;
                height: calc(100% - 10px);
                width: 50%;
                background: linear-gradient(180deg, #667aff 0%, #9e66ff 100%);
                border-radius: 7px;
                z-index: 1;
            }
            .pill-button-input {
                display: none;
                visibility: hidden;
            }
            .pill-button-selection {
                transition: all 0.2s;
                display: inline-block;
                position: relative;
                cursor: pointer;
                z-index: 2;
                padding: 5px;
            }
            .pill-button-selection_active {
                color: #fff;
            }

            .select {
                display: flex;
                flex-direction: column;
                gap: 1.25rem;
                max-height: 300px;
                overflow-y: scroll;
            }

            .select__item {
                padding: 10px;
                cursor: pointer;
                text-align: center;
                border-radius: 7px;
                background: #667aff;
                transition: background 0.3s;
                color: #ffffff;
                font-weight: 700;
            }

            .select__item--selected {
                background: #9e66ff;
                color: #ffffff;
                font-weight: 700;
            }
        </style>
    </head>
    <body
        class="font-montserrat bg-gradient-to-t from-secondaryPurple to-primaryPurple h-screen flex"
    >
        {%csrf_token%}
        <div
            class="m-auto p-4 w-11/12 flex flex-col items-center gap-8 h-[95%]"
        >
            {% comment %} switcher {% endcomment %}
            <div>
                <input
                    type="checkbox"
                    class="pill-button-input"
                    checked="checked"
                />
                <span class="pill-button">
                    <span
                        class="pill-button-selection pill-button-selection_on pill-button-selection_active"
                        >Configure</span
                    >
                    <span
                        class="pill-button-selection pill-button-selection_off"
                        >Generate</span
                    >
                    <span class="pill-button-highlight"></span>
                </span>
            </div>
            {% comment %} content {% endcomment %}
            <div class="bg-white h-full w-full" id="configureDiv">
                {% comment %} configure block {% endcomment %}
                <h1>Result CSV Normalization</h1>
                <form id="pdfForm" method="post" enctype="multipart/form-data">
                    <input type="file" name="pdf" accept=".csv" />
                    <button type="button" id="btn">Upload CSV</button>
                </form>
                <div id="result"></div>
            </div>
            {% comment %} generate block {% endcomment %}
            <div id="generateDiv" class="flex gap-5 w-full h-full">
                {% comment %} side block {% endcomment %}
                <div
                    id="sideDiv"
                    class="w-1/4 transition-all duration-300 bg-white p-8"
                >
                    {% comment %} steps counter {% endcomment %}
                    <div class="flex flex-col gap-5 justify-start">
                        <div
                            class="text-2xl flex items-center gap-4"
                            id="step1Heading"
                        >
                            <span
                                class="rounded-full aspect-square w-8 text-white inline-flex items-center justify-center bg-primaryPurple text-2xl"
                                >1</span
                            >
                            <div class="flex flex-col">
                                <span class="font-bold underline">
                                    Format Type
                                </span>
                                <span class="text-xl"></span>
                            </div>
                        </div>
                        <div
                            class="text-2xl flex items-center gap-4"
                            id="step2Heading"
                        >
                            <span
                                class="rounded-full aspect-square w-8 text-white inline-flex items-center justify-center bg-gray2 text-2xl"
                                >2</span
                            >
                            <div class="flex flex-col">
                                <span> Course </span>
                                <span class="text-xl"></span>
                            </div>
                        </div>
                        <div
                            class="text-2xl flex items-center gap-4"
                            id="step3Heading"
                        >
                            <span
                                class="rounded-full aspect-square w-8 text-white inline-flex items-center justify-center bg-gray2 text-2xl"
                                >3</span
                            >
                            <div class="flex flex-col">
                                <span> Semester </span>
                                <span class="text-xl"></span>
                            </div>
                        </div>
                        <div
                            class="text-2xl flex items-center gap-4"
                            id="step4Heading"
                        >
                            <span
                                class="rounded-full aspect-square w-8 text-white inline-flex items-center justify-center bg-gray2 text-2xl"
                                >4</span
                            >
                            <div class="flex flex-col">
                                <span> Year </span>
                                <span class="text-xl"></span>
                            </div>
                        </div>
                        <div
                            class="text-2xl flex items-center gap-4"
                            id="step5Heading"
                        >
                            <span
                                class="rounded-full aspect-square w-8 text-white inline-flex items-center justify-center bg-gray2 text-2xl"
                                >5</span
                            >
                            <div class="flex flex-col">
                                <span> Fromat Number </span>
                                <span class="text-xl"></span>
                            </div>
                        </div>
                    </div>
                </div>
                {% comment %} main block {% endcomment %}
                <div
                    class="w-3/4 bg-white p-8 flex flex-col justify-between"
                    id="formDiv"
                >
                    <div class="h-full">
                        <div
                            id="step1"
                            class="flex flex-col gap-12 justify-between"
                        >
                            <h1 class="text-4xl font-bold">
                                Select the format you want to generate:
                            </h1>
                            <select class="flex flex-col gap-4 custom-select">
                                <option value="Faculty">Faculty</option>
                                <option value="Management">Management</option>
                            </select>
                        </div>
                        <div
                            id="step2"
                            class="hidden flex flex-col gap-12 justify-between"
                        >
                            <h1 class="text-4xl font-bold">
                                Select the Course:
                            </h1>
                            <select
                                class="flex flex-col gap-4 custom-select"
                                id="custom-course-select"
                            ></select>
                        </div>
                        <div
                            id="step3"
                            class="hidden flex flex-col gap-12 justify-between"
                        >
                            <h1 class="text-4xl font-bold">
                                Select the Semester:
                            </h1>
                            <select
                                id="custom-semester-select"
                                class="flex flex-col gap-4 custom-select"
                            ></select>
                        </div>
                        <div
                            id="step4"
                            class="hidden flex flex-col gap-12 justify-between"
                        >
                            <h1 class="text-4xl font-bold">Select the Year:</h1>
                            <select
                                class="flex flex-col gap-4 custom-select"
                                id="custom-year-select"
                            ></select>
                        </div>
                        <div id="step5" class="hidden">5</div>
                        <div id="preview" class="hidden">Preview</div>
                    </div>
                    <div
                        class="flex items-center justify-between pt-4 border-t"
                    >
                        <button
                            id="previous"
                            class="invisible bg-primaryPurple p-2 rounded-md flex items-center gap-1 text-white text-2xl"
                        >
                            <img
                                src="{% static 'previous.svg' %}"
                                alt="arrow-left"
                            />
                            Back
                        </button>
                        <button
                            id="next"
                            class="bg-primaryPurple p-2 rounded-md flex items-center gap-1 text-white text-2xl"
                        >
                            Next
                            <img
                                src="{% static 'next.svg' %}"
                                alt="arrow-right"
                            />
                        </button>
                        <button
                            id="generate"
                            class="hidden bg-primaryPurple p-2 rounded-md flex items-center gap-1 text-white text-2xl"
                        >
                            Generate
                        </button>
                        <button
                            id="download"
                            class="hidden bg-primaryPurple p-2 rounded-md flex items-center gap-1 text-white text-2xl"
                        >
                            Download
                            <img
                                src="{% static 'download.svg' %}"
                                alt="download"
                            />
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let pillButtonOnText = document.querySelector(
                    ".pill-button-selection_on"
                ),
                pillButtonOffText = document.querySelector(
                    ".pill-button-selection_off"
                ),
                pillButtonHighlight = document.querySelector(
                    ".pill-button-highlight"
                ),
                pillButtonOnTextWidth = pillButtonOnText.offsetWidth,
                pillButtonOffTextWidth = pillButtonOffText.offsetWidth,
                pillButtonOnTextPosition = {
                    left: pillButtonOnText.offsetLeft,
                },
                pillButtonOffTextPosition = {
                    left: pillButtonOffText.offsetLeft,
                },
                pillButtonInput = document.querySelector(".pill-button-input"),
                configureDiv = document.querySelector("#configureDiv"),
                generateDiv = document.querySelector("#generateDiv");

            pillButtonHighlight.style.width = pillButtonOnTextWidth + "px";

            document
                .querySelectorAll(".pill-button-selection")
                .forEach(function (button) {
                    button.addEventListener("click", function () {
                        if (
                            !this.classList.contains(
                                "pill-button-selection_active"
                            )
                        ) {
                            document
                                .querySelectorAll(".pill-button-selection")
                                .forEach(function (element) {
                                    element.classList.remove(
                                        "pill-button-selection_active"
                                    );
                                });
                            this.classList.add("pill-button-selection_active");

                            if (
                                this.classList.contains(
                                    "pill-button-selection_off"
                                ) &&
                                pillButtonInput.checked
                            ) {
                                pillButtonInput.checked = false;
                                configureDiv.style.display = "none";
                                generateDiv.style.display = "flex";
                                pillButtonHighlight.style.width =
                                    pillButtonOffTextWidth + "px";
                                pillButtonHighlight.style.left =
                                    pillButtonOffTextPosition.left + "px";
                            } else {
                                pillButtonInput.checked = true;
                                configureDiv.style.display = "block";
                                generateDiv.style.display = "none";
                                pillButtonHighlight.style.width =
                                    pillButtonOnTextWidth + "px";
                                pillButtonHighlight.style.left =
                                    pillButtonOnTextPosition.left + "px";
                            }
                        }
                    });
                });

            if (pillButtonInput.checked) {
                pillButtonHighlight.style.width = pillButtonOnTextWidth + "px";
                configureDiv.style.display = "block";
                generateDiv.style.display = "none";
            } else {
                pillButtonHighlight.style.width = pillButtonOffTextWidth + "px";
                configureDiv.style.display = "none";
                generateDiv.style.display = "block";
            }

            // next and previous button
            const next = document.getElementById("next"),
                previous = document.getElementById("previous"),
                generate = document.getElementById("generate"),
                download = document.getElementById("download"),
                step1 = document.getElementById("step1"),
                step2 = document.getElementById("step2"),
                step3 = document.getElementById("step3"),
                step4 = document.getElementById("step4"),
                step5 = document.getElementById("step5"),
                previewDiv = document.getElementById("preview"),
                step1Heading = document.getElementById("step1Heading"),
                step2Heading = document.getElementById("step2Heading"),
                step3Heading = document.getElementById("step3Heading"),
                step4Heading = document.getElementById("step4Heading"),
                step5Heading = document.getElementById("step5Heading");

            hideAllSteps = () => {
                step1.classList.add("hidden");
                step2.classList.add("hidden");
                step3.classList.add("hidden");
                step4.classList.add("hidden");
                step5.classList.add("hidden");
                previewDiv.classList.add("hidden");

                step1Heading.children[0].classList.remove("bg-primaryPurple");
                step2Heading.children[0].classList.remove("bg-primaryPurple");
                step3Heading.children[0].classList.remove("bg-primaryPurple");
                step4Heading.children[0].classList.remove("bg-primaryPurple");
                step5Heading.children[0].classList.remove("bg-primaryPurple");

                step1Heading.children[0].classList.remove("bg-secondaryPurple");
                step2Heading.children[0].classList.remove("bg-secondaryPurple");
                step3Heading.children[0].classList.remove("bg-secondaryPurple");
                step4Heading.children[0].classList.remove("bg-secondaryPurple");
                step5Heading.children[0].classList.remove("bg-secondaryPurple");

                step1Heading.children[1].children[0].classList.remove(
                    "font-bold"
                );
                step2Heading.children[1].children[0].classList.remove(
                    "font-bold"
                );
                step3Heading.children[1].children[0].classList.remove(
                    "font-bold"
                );
                step4Heading.children[1].children[0].classList.remove(
                    "font-bold"
                );
                step5Heading.children[1].children[0].classList.remove(
                    "font-bold"
                );

                step1Heading.children[1].children[0].classList.remove(
                    "underline"
                );
                step2Heading.children[1].children[0].classList.remove(
                    "underline"
                );
                step3Heading.children[1].children[0].classList.remove(
                    "underline"
                );
                step4Heading.children[1].children[0].classList.remove(
                    "underline"
                );
                step5Heading.children[1].children[0].classList.remove(
                    "underline"
                );

                step1Heading.children[1].children[0].classList.remove(
                    "line-through"
                );
                step2Heading.children[1].children[0].classList.remove(
                    "line-through"
                );
                step3Heading.children[1].children[0].classList.remove(
                    "line-through"
                );
                step4Heading.children[1].children[0].classList.remove(
                    "line-through"
                );
                step5Heading.children[1].children[0].classList.remove(
                    "line-through"
                );

                step1Heading.children[1].children[1].classList.add("hidden");
                step2Heading.children[1].children[1].classList.add("hidden");
                step3Heading.children[1].children[1].classList.add("hidden");
                step4Heading.children[1].children[1].classList.add("hidden");
                step5Heading.children[1].children[1].classList.add("hidden");
            };

            updateStep = () => {
                hideAllSteps();
                switch (currentStep) {
                    case 1:
                        step1.classList.remove("hidden");
                        step1Heading.children[1].children[0].classList.add(
                            "underline"
                        );
                        step1Heading.children[1].children[0].classList.add(
                            "font-bold"
                        );
                        step1Heading.children[0].classList.add(
                            "bg-primaryPurple"
                        );
                        break;
                    case 2:
                        step2.classList.remove("hidden");
                        step2Heading.children[1].children[0].classList.add(
                            "underline"
                        );
                        step2Heading.children[1].children[0].classList.add(
                            "font-bold"
                        );
                        step2Heading.children[0].classList.add(
                            "bg-primaryPurple"
                        );
                        break;
                    case 3:
                        step3.classList.remove("hidden");
                        step3Heading.children[1].children[0].classList.add(
                            "underline"
                        );
                        step3Heading.children[1].children[0].classList.add(
                            "font-bold"
                        );
                        step3Heading.children[0].classList.add(
                            "bg-primaryPurple"
                        );
                        break;
                    case 4:
                        step4.classList.remove("hidden");
                        step4Heading.children[1].children[0].classList.add(
                            "font-bold"
                        );
                        step4Heading.children[1].children[0].classList.add(
                            "underline"
                        );
                        step4Heading.children[0].classList.add(
                            "bg-primaryPurple"
                        );
                        break;
                    case 5:
                        step5.classList.remove("hidden");
                        step5Heading.children[1].children[0].classList.add(
                            "font-bold"
                        );
                        step5Heading.children[1].children[0].classList.add(
                            "underline"
                        );
                        step5Heading.children[0].classList.add(
                            "bg-primaryPurple"
                        );
                        break;
                }

                for (let i = 1; i < currentStep; i++) {
                    document
                        .getElementById(`step${i}Heading`)
                        .children[0].classList.add("bg-secondaryPurple");
                    document
                        .getElementById(`step${i}Heading`)
                        .children[1].children[0].classList.remove("underline");
                    document
                        .getElementById(`step${i}Heading`)
                        .children[1].children[0].classList.remove("font-bold");
                    document
                        .getElementById(`step${i}Heading`)
                        .children[1].children[0].classList.add("line-through");
                    document
                        .getElementById(`step${i}Heading`)
                        .children[1].children[1].classList.remove("hidden");
                    document.getElementById(
                        `step${i}Heading`
                    ).children[1].children[1].textContent =
                        formData[Object.keys(formData)[i - 1]];
                }
            };

            let currentStep = 1;
            next.addEventListener("click", function () {
                previous.classList.remove("invisible");
                if (currentStep <= 5) {
                    currentStep < 5 && currentStep++;
                    currentStep === 5;
                    if (currentStep === 5) {
                        generate.classList.remove("hidden");
                        next.classList.add("invisible");
                    } else {
                        next.classList.remove("invisible");
                    }
                    updateStep();
                }
            });

            previous.addEventListener("click", function () {
                next.classList.remove("invisible");
                previewDiv.classList.add("hidden");
                generate.classList.add("hidden");
                download.classList.add("hidden");
                formData[Object.keys(formData)[currentStep - 2]] = "";

                const options = Array.from(document.getElementById(
                    `step${currentStep - 1}`
                ).children[2].children)
                options.forEach((option) => {
                    option.classList.remove("select__item--selected");
                });

                if (currentStep > 1) {
                    currentStep--;
                    currentStep === 1
                        ? previous.classList.add("invisible")
                        : previous.classList.remove("invisible");
                    if (currentStep === 5) {
                        next.classList.add("invisible");
                        generate.classList.remove("hidden");
                    }
                    updateStep();
                }
            });

            generate.addEventListener("click", function () {
                currentStep < 6 && currentStep++;
                updateStep();
                step5.classList.add("hidden");
                previewDiv.classList.remove("hidden");
                generate.classList.add("hidden");
                download.classList.remove("hidden");

                // handle generate
                console.log("generate ", formData);
            });

            download.addEventListener("click", function () {
                // handle download
                console.log("download");
            });

            // generate form data
            let formData = {
                format_type: "",
                course: "",
                semester: "",
                year: "",
                format_number: "",
            };

            // courses data
            let courses = [
                "BCA - Morning",
                "BCA - Evening",
                "(B.Com H) - Morning",
                "(B.Com H) - Evening",
                "(BBA B&I) - Morning",
                "(BBA B&I) - Evening",
                "(BBA G) - Morning",
                "(BBA G) - Evening",
                "(BBA LLB)",
                "(BA LLB)",
                "B.Ed",
                "MBA",
            ];
            const customCourseSelect = document.getElementById(
                "custom-course-select"
            );
            courses.forEach((course) => {
                const option = document.createElement("option");
                option.value = course;
                option.textContent = course;
                customCourseSelect.appendChild(option);
            });

            // custom semester select
            let semesterByCourse = {
                "BCA - Morning": 6,
                "BCA - Evening": 6,
                "(B.Com H) - Morning": 6,
                "(B.Com H) - Evening": 6,
                "(BBA B&I) - Morning": 6,
                "(BBA B&I) - Evening": 6,
                "(BBA G) - Morning": 6,
                "(BBA G) - Evening": 6,
                "(BBA LLB)": 10,
                "(BA LLB)": 10,
                "B.Ed": 4,
                MBA: 4,
            };
            const customSemesterSelect = document.getElementById(
                "custom-semester-select"
            );
            function addSemesterOptions(selectedCourseOption) {
                if (selectedCourseOption in semesterByCourse) {
                    customSemesterSelect.innerHTML = "";
                    for (
                        let i = 1;
                        i <= semesterByCourse[selectedCourseOption];
                        i++
                    ) {
                        const option = document.createElement("option");
                        option.value = `Semester ${i}`;
                        option.textContent = `Semester ${i}`;
                        customSemesterSelect.appendChild(option);
                    }
                }
            }
            const observerForCourse = new MutationObserver((mutations) => {
                for (let i = 2; i <= step3.children.length; i++) {
                    step3.children[i].remove();
                }
                new CustomSelect(customSemesterSelect);
            });
            observerForCourse.observe(customSemesterSelect, {
                childList: true,
            });

            // custom-year-select
            const customYearSelect =
                document.getElementById("custom-year-select");
            function addYearOptions() {
                const yearDiff = semesterByCourse[formData.course] / 2;
                customYearSelect.innerHTML = "";
                const currentYear = new Date().getFullYear();
                for (let i = 0; i <= yearDiff; i++) {
                    const option = document.createElement("option");
                    option.value = currentYear + yearDiff - i;
                    option.textContent = currentYear + yearDiff - i;
                    customYearSelect.appendChild(option);
                }
                for (let i = 1; i <= yearDiff; i++) {
                    const option = document.createElement("option");
                    option.value = currentYear - i;
                    option.textContent = currentYear - i;
                    customYearSelect.appendChild(option);
                }
            }
            const observerForYear = new MutationObserver((mutations) => {
                if (formData.year !== "") return;
                for (let i = 2; i <= step4.children.length; i++) {
                    step4.children[i].remove();
                }
                new CustomSelect(customYearSelect);
            });
            observerForYear.observe(customYearSelect, { childList: true });

            //  custom select
            class CustomSelect {
                constructor(originalSelect) {
                    this.originalSelect = originalSelect;
                    this.customSelect = document.createElement("div");
                    this.customSelect.classList.add("select");

                    this.originalSelect
                        .querySelectorAll("option")
                        .forEach((optionElement) => {
                            const itemElement = document.createElement("div");

                            itemElement.classList.add("select__item");
                            itemElement.textContent = optionElement.value;
                            this.customSelect.appendChild(itemElement);

                            itemElement.addEventListener("click", () => {
                                if (
                                    itemElement.classList.contains(
                                        "select__item--selected"
                                    )
                                ) {
                                    this._deselect(itemElement);
                                } else {
                                    this._select(itemElement);
                                }
                            });
                        });

                    this.originalSelect.insertAdjacentElement(
                        "afterend",
                        this.customSelect
                    );
                    this.originalSelect.style.display = "none";
                }

                _select(itemElement) {
                    const index = Array.from(
                        this.customSelect.children
                    ).indexOf(itemElement);

                    this.customSelect
                        .querySelectorAll(".select__item")
                        .forEach((el) => {
                            el.classList.remove("select__item--selected");
                        });

                    this.originalSelect.querySelectorAll("option")[
                        index
                    ].selected = true;
                    let value =
                        this.originalSelect.querySelectorAll("option")[index]
                            .value;
                    this._setFormData(value);
                    itemElement.classList.add("select__item--selected");
                    addSemesterOptions(itemElement.textContent);
                    addYearOptions();
                }

                _setFormData(value) {
                    formData[Object.keys(formData)[currentStep - 1]] = value;
                }

                _deselect(itemElement) {
                    const index = Array.from(
                        this.customSelect.children
                    ).indexOf(itemElement);

                    this.originalSelect.querySelectorAll("option")[
                        index
                    ].selected = false;
                    itemElement.classList.remove("select__item--selected");
                }
            }

            document
                .querySelectorAll(".custom-select")
                .forEach((selectElement) => {
                    new CustomSelect(selectElement);
                });

            // configure form
            btn = document.getElementById("btn");
            btn.addEventListener("click", function (event) {
                event.preventDefault();
                form = document.getElementById("pdfForm");
                const formData = new FormData(form);
                console.log(formData);

                fetch("http://127.0.0.1:8000/results/normalize/", {
                    method: "POST",
                    body: formData,
                })
                    .then((response) => response.blob())
                    .then((blob) => {
                        console.log(blob);
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = "normalized.xlsx";
                        a.textContent = "Download Normalized excel file";
                        document.getElementById("result").appendChild(a);
                    })
                    .catch((error) => {
                        console.error("Fetch Error:", error);
                    });
            });
        </script>
    </body>
</html>
