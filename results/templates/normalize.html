<div class="configure-box">




    <h1>Result CSV Normalization</h1>
    <form id="pdfForm" method="post" enctype="multipart/form-data">
        <input type="file" name="pdf" accept=".csv" />
        <button type="button" id="btn">Upload CSV</button>  
    </form>
<div id="result"></div>

<div id="result_blocks">
</div>


<button class="download-master">Download Master sheet</button>

    <script>
        // quering backend to check availability of result for semesters
        // make this ajax call after the form with all the data is filled
        // create the below object form the form data
        details = {
            "course": "BCA",
            "passing": "2024",
            "shift": "1"
        }
        
        available_semesters = null
        fetch("http://localhost:8000/results/check-result/", {
            method: "POST",
            body: JSON.stringify(details),
            headers: {
                "Content-Type": "application/json"
            }
        }).then(response => {
            return response.json()
        }).then(data => {
            available_semesters = Object.keys(data)
            
            console.log(available_semesters)
            let total_semesters = 6 // this will be generated by logic on course name
      
      // create semester block for each semester
      for(let i=1; i<=total_semesters; i++){
          let semester_block = document.createElement("div")
          semester_block.classList.add("semester-block")
          if (available_semesters.includes(i.toString())){
          semester_block.innerHTML = `
              <p class="semester-title">Semester ${i}</p>
              <a href="/results/download-result/${data[i]} " class="download-btn">Download</a>
              <form id="pdfForm" method="post" enctype="multipart/form-data">
                <input type="file" id="updated_result" name="updated_result" accept=".xlsx" />
                <button type="button" onclick="update_result(${i})" id="btn">Update </button>  
            </form>
          `
          document.getElementById("result_blocks").appendChild(semester_block)
      }
      else{
          semester_block.innerHTML = `
              <p class="semester-title">Semester ${i}</p>
              
              <input type="file" id="excel-${i}" name="excelfile" accept=".csv" />
            <button type="button" class ="upload_button" onclick="upload_excel(${i})"  id="btn-${i}">Upload </button>  
          `
          document.getElementById("result_blocks").appendChild(semester_block)
      }
      }
        }).catch(err => {
            console.log(err)
        } )

    function upload_excel(excelnumber){
        file_to_be_uploaded = document.getElementById(`excel-${excelnumber}`).files[0]

        const formData = new FormData();
    formData.append('excel_file', file_to_be_uploaded );  // 'excel_file' is the name you will use on the server to access the file
    formData.append('course', details.course);
    formData.append('passing', details.passing);
    formData.append('shift', details.shift);
    formData.append('semester', excelnumber);

    fetch("http://localhost:8000/results/normalize/", {
        method: 'POST',
        body: formData,  // Use FormData as the request body
    }).then(response => {
        return response.json();
    }).then(data => {
        console.log(data);
        document.getElementById("result").innerHTML = data;
    }).catch(err => {
        console.log(err);
    });

        




    }
    
    function update_result(id){

        file_to_be_uploaded = document.getElementById("updated_result").files[0]

        const formData = new FormData();
    formData.append('updated_excel_file', file_to_be_uploaded );  // 'updated_excel_file' is the name you will use on the server to access the file
    formData.append('course', details.course);
    formData.append('passing', details.passing);
    formData.append('shift', details.shift);
    formData.append('semester', id);

    fetch("http://localhost:8000/results/update-result/", {
        method: 'POST',
        body: formData,  // Use FormData as the request body
    }).then(response => {
        return response.json();
    }).then(data => {
        console.log(data);
        
    }).catch(err => {
        console.log(err);
    });}



    
    
      

    </script>



</div>